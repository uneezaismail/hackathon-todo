# API Contracts: FastAPI Backend Phase II

**Date**: 2025-12-11
**Feature**: 002-fastapi-backend
**Purpose**: RESTful API contract specifications, request/response schemas, and examples

---

## Overview

This directory contains the **API contract definitions** for the FastAPI Todo Backend. The OpenAPI 3.1 specification is automatically generated by FastAPI from Pydantic schemas and route definitions.

### Directory Structure

```text
contracts/
├── README.md                       # This file
├── openapi.yaml                    # OpenAPI 3.1 spec (manually documented, generated at runtime by FastAPI)
├── schemas/                        # JSON Schema definitions for request/response models
│   ├── task_create.json            # TaskCreate request schema
│   ├── task_update.json            # TaskUpdate request schema
│   ├── task_response.json          # TaskResponse schema (single task)
│   ├── task_list_response.json     # TaskListResponse schema (paginated list)
│   └── error_response.json         # ErrorResponse schema (all errors)
└── examples/                       # Example request/response payloads
    ├── create_task_request.json    # Example POST /api/v1/tasks request
    ├── create_task_response.json   # Example 201 Created response
    ├── update_task_request.json    # Example PATCH /api/v1/tasks/{id} request
    ├── list_tasks_response.json    # Example GET /api/v1/tasks response
    └── error_responses/            # Example error responses
        ├── 400_validation_error.json
        ├── 401_unauthorized.json
        ├── 403_forbidden.json
        ├── 404_not_found.json
        └── 503_service_unavailable.json
```

---

## API Endpoints Summary

| Method | Endpoint                    | Auth Required | Description |
|--------|-----------------------------|---------------|-------------|
| POST   | `/api/v1/tasks`             | ✅ Yes        | Create new task |
| GET    | `/api/v1/tasks`             | ✅ Yes        | List user's tasks (with filters, sorting, pagination) |
| GET    | `/api/v1/tasks/{task_id}`   | ✅ Yes        | Get single task by ID |
| PATCH  | `/api/v1/tasks/{task_id}`   | ✅ Yes        | Update task (title, description, completed status) |
| DELETE | `/api/v1/tasks/{task_id}`   | ✅ Yes        | Delete task permanently |
| GET    | `/api/health`               | ❌ No         | Health check (public endpoint) |

---

## Authentication

All endpoints (except `/api/health`) require **JWT authentication** via the `Authorization` header:

```http
Authorization: Bearer <JWT_TOKEN>
```

**Token Source**: Better Auth (Next.js frontend) issues JWT tokens with user ID in `sub` claim.

**Token Validation**:
- Signature verified using shared `BETTER_AUTH_SECRET` (HS256 algorithm)
- User ID extracted from `sub` claim
- User ID validated against URL path (e.g., `/api/v1/users/{user_id}/tasks`)
- Invalid/expired tokens → HTTP 401 Unauthorized

**Example Valid Token Header**:
```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXVzZXItMTIzIiwiZXhwIjoxNzM1NzQwMDAwfQ.xxx
```

---

## Response Format

All API responses follow the standardized format (from spec FR-011):

### Success Response
```json
{
  "data": { /* Response data */ },
  "error": null
}
```

### Error Response
```json
{
  "data": null,
  "error": {
    "message": "Human-readable error message",
    "code": "MACHINE_READABLE_ERROR_CODE"
  }
}
```

---

## HTTP Status Codes

| Status Code | Meaning | When Used |
|-------------|---------|-----------|
| 200 OK | Success | GET /api/v1/tasks, GET /api/v1/tasks/{id}, PATCH /api/v1/tasks/{id} |
| 201 Created | Resource created | POST /api/v1/tasks |
| 204 No Content | Success, no body | DELETE /api/v1/tasks/{id} |
| 400 Bad Request | Validation error | Empty title, title >200 chars, invalid query params |
| 401 Unauthorized | Missing/invalid JWT | No Authorization header, expired token, invalid signature |
| 403 Forbidden | Authorization failure | User tries to access another user's task |
| 404 Not Found | Resource not found | Task ID doesn't exist |
| 422 Unprocessable Entity | Malformed request | Invalid JSON, invalid UUID format |
| 500 Internal Server Error | Unexpected error | Unhandled exception (rare) |
| 503 Service Unavailable | Database down | Neon database connection failure |

---

## Accessing API Documentation

When the FastAPI server is running (`uvicorn src.main:app --reload`):

- **Swagger UI** (Interactive): http://localhost:8000/docs
- **ReDoc** (Read-only): http://localhost:8000/redoc
- **OpenAPI JSON**: http://localhost:8000/openapi.json

---

## Contract Testing

All request/response schemas are validated against the OpenAPI spec in:

```bash
tests/contract/test_openapi_schema.py
```

Run contract tests:
```bash
uv run pytest tests/contract/ -v
```

---

## Usage Examples

See `examples/` directory for complete request/response examples for each endpoint.

Quick test with curl:

```bash
# Create task
curl -X POST http://localhost:8000/api/v1/tasks \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d @contracts/examples/create_task_request.json

# List tasks
curl -X GET "http://localhost:8000/api/v1/tasks?status=Pending&limit=10" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# Update task
curl -X PATCH http://localhost:8000/api/v1/tasks/{task_id} \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d @contracts/examples/update_task_request.json

# Delete task
curl -X DELETE http://localhost:8000/api/v1/tasks/{task_id} \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

---

**Contracts Status**: ✅ DOCUMENTED
**Generated**: 2025-12-11
**Runtime OpenAPI Spec**: Available at http://localhost:8000/openapi.json when server is running
